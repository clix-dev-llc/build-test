version: '1.0'
# see https://hub.docker.com/r/progrium/stress/


steps:
  build:
    type: build
    image-name: codefresh/build-test
  
  push:
    type: push
    candidate: ${{build}}
    # tag: latest
    image_name: codefresh/build-test

  cpu-sqrt:
    image: ${{build}}
    commands:
      - cpu-sqrt

  fio-randwrite-direct-bs8m-size1G-1jobs:
    image: ${{build}}
    commands:
      - fio --name=randwrite --ioengine=libaio --iodepth=1 --rw=randwrite --bs=8192k --direct=1 --size=1G --numjobs=1 --group_reporting
      - rm -rf randread* randwite*      
    #fail_fast: false
    #on_finish:
    #  - rm -rf randread* randwite*

  fio-randread-direct-bs8m-size1G-1jobs:
    image: ${{build}}
    commands:
      - fio --name=randread --ioengine=libaio --iodepth=1 --rw=randwrite --bs=8192k --direct=1 --size=1G --numjobs=1 --group_reporting
      - rm -rf randread* randwite*  
    #fail_fast: false
    #on_finish:
    #  - rm -rf randread* randwite*

  fio-randwrite-direct-bs4k-size32M-4jobs:
    image: ${{build}}
    commands:
      - fio --name=randwrite --ioengine=libaio --iodepth=1 --rw=randwrite --bs=4k --direct=1 --size=32M --numjobs=4 --group_reporting
      - rm -rf randread* randwite*

    #fail_fast: false
    # on_finish:
    #   - rm -rf randread* randwite*

  fio-randread-direct-bs4k-size32M-4jobs:
    image: ${{build}}
    commands:
      - fio --name=randread --ioengine=libaio --iodepth=1 --rw=randwrite --bs=4k --direct=1 --size=32M --numjobs=4 --group_reporting
      - rm -rf randread* randwite*

    #fail_fast: true
    # on_finish:
    #   - rm -rf randread* randwite*

  # stress:
  #   image: progrium/stress
  #   commands: 
  #     - stress --cpu ${{CPUS}} --vm ${{MEM256}} --timeout ${{TIMEOUT}}
